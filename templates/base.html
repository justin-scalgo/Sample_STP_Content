<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>STP CMS</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-modal/0.9.1/jquery.modal.min.css" />
  <style>
    body {
      background-color: #ffffff;
      margin: 0;
      padding: 0;
    }

    header {
      background-color: grey;
      color: black;
      padding: 20px;
      height: 40px;
    }

    .content {
      margin: 20px;
    }

    .content-container {
      height: 500px; /* Adjust the height as needed */
      border: 1px solid #ccc;
      overflow: auto; /* Enable scrolling when content overflows the height */
      padding: 10px;
    }

    form {
      margin: 20px 0;
    }

    input[type="text"],
    textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
    }

    button[type="submit"] {
      padding: 10px 20px;
      background-color: #333;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    button[type="submit"]:hover {
      background-color: #555;
    }

    label {
      display: block;
      font-weight: bold;
      margin-bottom: 5px;
    }

    /* / List content styles / */
    ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    li {
      margin-bottom: 20px;
    }

    h3 {
      margin: 0;
    }

    p {
      margin: 10px 0;
    }

    img {
      max-width: 100%;
      height: auto;
    }
  </style>
</head>

<body>
  <header>
    <h1>CMS Page</h1>
    <!-- <button id="modal-trigger">Open Modal</button> -->
  </header>
  <div class="content">
    {% block content %}
    {% endblock %}
  </div>


  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <!-- Include jQuery Modal plugin -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-modal/0.9.1/jquery.modal.min.js"></script>


  <div id="myModal" class="modal">
    <div class="modal-content">
      <form id="add-content-form" method="post">
        <input type="hidden" id="new_id" name="new_id">
        {% csrf_token %}
        <label for="title">Title:</label>
        <input type="text" id="title" name="title" required>
        <br>
        <label for="description">Description:</label>
        <textarea id="description" name="description" required></textarea>
        <br>
        <!-- Add other form fields as needed -->
        <button type="button" class="btn btn-primary test_class">Add</button>
        <!-- <a href="#" id="open-modal">Add</a> -->
      </form>
    </div>
  </div>



  <div id="myModal_1" class="modal">
    <div class="modal-content">
      <form id="edit-content-form" method="PUT">
        {% csrf_token %}
        <input type="hidden" id="old_id" name="old_id">
        <label for="title">Title:</label>
        <input type="text" id="title_1" name="title" required>
        <br>
        <label for="description">Description:</label>
        <textarea id="description_1" name="description" required></textarea>
        <br>
        <!-- Add other form fields as needed -->
        <button type="button" class="btn btn-primary" id="editBtn">Update</button>
        <!-- <a href="#" id="open-modal">Add</a> -->
      </form>
    </div>
  </div>

  <div id="myModal_2" class="modal">
    <div class="modal-content">
      <form id="delete-content-form" method="POST">
        {% csrf_token %}
        <input type="hidden" id="old_id_1" name="old_id_1">
        <!-- <p>Are you sure you want to delete this item?</p> -->
        <label for="title">Title:</label>
        <input type="text" id="title_2" name="title" required>
        <br>
        <!-- Add other form fields as needed -->
        <button type="button" class="btn btn-primary" id="delbtn">Delete</button>
        <!-- <a href="#" id="open-modal">Add</a> -->
      </form>
    </div>
  </div>


  <script>
    $(document).ready(function () {
      // Open modal when the button is clicked
      $('#open-modal').on('click', function () {
        $('#myModal').modal();
      });

      // Close modal when the close button is clicked
      // $('#close-modal').on('click', function () {
      //   $('#myModal').hide();
      // });

      $(".test_class").click(function (e) {
        //   alert(1)
        e.preventDefault();
        var title = $("#title").val();
        var description = $("#description").val();
        if (title.trim() === '' || description.trim() === '') {
          alert("Please fill in both title and description fields.");
          return; // Do not proceed with the AJAX request
        }
        // var id = $("#new_id").val()
        var jsonData = {
          'title': title,
          'description': description
        }
        $.ajax({
          type: 'POST',
          url: "{% url 'add_content' %}",
          data: JSON.stringify(jsonData),  // Convert JSON object to string
          contentType: 'application/json', // Set content type to JSON
          headers: { 'X-CSRFToken': '{{ csrf_token }}' }, // Include CSRF token in headers
          success: function (response) {
            if (response.status) {
              // console.log(response);
              var successMessage = response.message
              alert(successMessage);
              $("#title").val('');
              $("#description").val('');
              $('#myModal').hide();
              $('.jquery-modal').removeClass('blocker');

              // Append the new content to the table without refreshing the page
              var newRow = '<tr id="row_' + response.content.id + '">' +'<td>' + response.content.title + '</td>' +'<td>' + response.content.description + '</td>' +'<td>' + response.content.createdDate + '</td>' +'<td><a href="#" class="edit" data-id="' + response.content.id + '">Edit</a></td>' +'<td><a href="#" class="delete" data-id="' + response.content.id + '">Delete</a></td>' +'</tr>';
              $("#content-table").append(newRow);
              
             
            }
          },
          error: function (response) {
            // alert the error if any error occured
            console.log(response)
            alert(response.message);
          }
        });

      });
      $(document).on('click','.edit', function (e) {
        // $(".edit").click(function (e) {
        event.preventDefault();
        var id = $(this).attr('data-id');
        $.ajax({
          type: 'GET',
          url: "cms-content/" + id + "/",

          success: function (response) {
            $('#myModal_1').modal();
            $('#title_1').val(response.title);
            $('#description_1').val(response.description);
            $('#old_id').val(response.id);
            // $('#createdDate_1').text(response.createdDate);
            // Populate the form with the fetched data

          },
          error: function (response) {
            // Handle error response
            console.log(response);
          }
        });

      });
      $('#editBtn').on('click', function (e) {
        event.preventDefault();
        var id = $('#old_id').val();
        // var createdDate = $('#createdDate_1').text();
        // var id = $(this).attr('#id');
        // console.log('old_id:', id);
        $.ajax({
          type: 'POST',
          url: "/edit/",
          headers: { 'X-CSRFToken': '{{ csrf_token }}' }, // Include CSRF token in headers
          data: {
            title: $('#title_1').val(),
            description: $('#description_1').val(),
            id: id,
            // createdDate: createdDate,

          },
          success: function (response) {
            // Handle success response
            console.log(response);
            // Close the modal or perform any other action
            $('#myModal_1').hide();
            $('.jquery-modal').removeClass('blocker'); 

            // $('#createdDate_1').text(response.createdDate);
            // var htm = '<td>' + response.title + '</td><td>' + response.description + '</td><td>' + response.createdDate + '</td><td><a href="#" class="edit" data-id="{{ item.id }}">Edit</a></td><td><a href="#" class="delete" data-id="{{ item.id }}">Delete</a></td>';
            // $("#row_" + id).html(htm);
            var editedRow = $('#row_' + response.id);
            editedRow.find('td:eq(0)').text(response.title);
            editedRow.find('td:eq(1)').text(response.description);
            editedRow.find('td:eq(2)').text(response.createdDate);
          },
          error: function (response) {
            // Handle error response
            console.log(response);
          }
        });
      }); 

      // $(document).ready(function () {
      // Delete button click event
      // Assuming you have jQuery included in your project
      $(document).on('click', '.delete', function (e) {
        // Delete button click event
        // $(".delete").click(function (e) {
        event.preventDefault();
        var id = $(this).attr('data-id');
        $.ajax({
          type: 'GET',
          url: "cms-content/" + id + "/",

          success: function (response) {
            $('#myModal_2').modal();
            $('#title_2').val(response.title);
            $('#description_2').val(response.description);
            $('#old_id_1').val(response.id);
            // Populate the form with the fetched data

          },
          error: function (response) {
            // Handle error response
            console.log(response);
          }
        });

      })
      $('#delbtn').on('click', function (e) {
        e.preventDefault();
        // var rowId = $(this).closest('tr').attr('id');
        // var contentId = $(this).closest('tr').data('item-id');

        // Display the confirmation popup
        var confirmed = confirm("Are you sure you want to delete this item?");

        // Check the user's response
        if (confirmed) {
          // If confirmed, perform the delete operation
          var id = $('#old_id_1').val()
          $.ajax({
            type: 'POST',
            url: "/delete/",
            headers: { 'X-CSRFToken': '{{ csrf_token }}' },
            data: {
              title: $('#title_2').val(),
              description: $('#description_2').val(),
              id: id

            },
            success: function (response) {
              // Handle success response
              console.log(response);
              $('#myModal_2').hide();
              $('.jquery-modal').removeClass('blocker');
              // Remove the deleted row from the table
              $('#row_' + response.id).remove();
            },
            error: function (response) {
              // Handle error response
              console.log(response);
            }
          });
        } else {
          // If not confirmed, do nothing or perform any desired action
          alert("Item deletion canceled.");
        }
      });
    });





  </script>

</body>

</html>